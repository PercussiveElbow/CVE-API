require "kemal"
require "json"
require "db"
require "pg"

db_path = ENV["PG_PATH"]

if !db_path 
  puts("Set PG_PATH env var. Format postgres://user:pass@host:port/db_name")
  exit(1)
end
db = DB.connect(db_path)

get "/" do |env| 
  "CVE API"
end

get "/:cve" do |env|
  cve = env.params.url["cve"]
  env.response.content_type = "application/json"
  
  if !(cve.matches?(/CVE-\d{4}-\d{4,7}/))
    response = {"error" => "CVE not found."}.to_json
  else
    cve_json = ""
    cve_info = db.query("SELECT cve_details FROM cves WHERE cveid = ($1) ", cve) do | rs |
      rs.each do 
        cve_value = rs.read(JSON::Any)
        cve_json =  cve_value
      end
      response = {cve => cve_json}.to_json
    end
  end
  response
end

Kemal.run