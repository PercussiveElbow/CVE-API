# Build image to compile the app
FROM crystallang/crystal:latest-alpine AS builder
RUN apk update && apk upgrade && apk --no-cache add ca-certificates
WORKDIR /app
RUN adduser -S lowpriv
COPY ./src /app/src/
COPY ./shard.yml /app/shard.yml
RUN shards install
RUN crystal build --static --release /app/src/cve-api.cr 

# Build the lightweight busybox based image
FROM scratch
COPY --from=builder /etc/passwd /etc/passwd
COPY --from=builder  /app/cve-api /app/cve-api
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/cert.pem
USER lowpriv
ENTRYPOINT ["/app/cve-api"]